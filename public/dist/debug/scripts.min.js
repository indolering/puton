var tmpl={};tmpl.app="<div id='puton-container'>    <h1 id='puton-heading'>Puton</h1>    <div id='puton-main'></div>    <a id='puton-hide-button'></a>    <div id='puton-log'></div></div>",tmpl.mainView="<div class='puton-section'>    <h2>Open a Pouch:</h2>    <div class='puton-main-input'>        <label class='puton-db-label' for='puton-db-input'>Pouch(</label>        <input type='text' id='puton-db-input'/>        <label class='puton-db-label' for='puton-db-input'>);</label>    </div></div><div class='puton-section'>    <h2>Existing Pouches:</h2>    <%  if (allDbs.length === 0) { %>        <p class='puton-db-info'>No Existing Pouches :(</p>    <%  } else { %>        <ul class='puton-dbnames'>            <%  _.each(allDbs, function(db) { %>                <li class='puton-dbname'><%= db %></li>            <% }) %>        </ul>    <% } %></div>",tmpl.addDocForm="<div class='puton-caret'>    <div class='puton-innercaret'></div>    <div class='puton-outercaret'></div></div><textarea class='puton-add-doc-form' name='addDocForm'>{\n\n\n\n}</textarea><button class='puton-code-edit-cancel'>Cancel</button><button class='puton-code-edit-save'>Save</button>",tmpl.log="<p class='log log-<%- type %>'>    <b>        <small class='count'>            <%- count %>        </small>    </b>    <%- log %></p>",tmpl.db="<h2 id='puton-dbname'><%- db_name %></h2><p class='puton-dbinfo'>    &middot;    <b>doc_count: </b>    <%- doc_count %>    &middot;    <b>update_seq: </b>    <%- update_seq %></p><div id='puton-toolbar'></div><div id='puton-tabs'>    <div class='puton-docs'></div></div>",tmpl.doc_full="<h3 class='puton-doc-key'><%- key %><small><%- rev%></small></h3><div class='puton-doc-optionsbar'><a class='option revtreeoption'>rev-tree</a>&nbsp;<a class='option revoption'>rev-list</a>&nbsp;<a class='option editoption'>edit</a>&nbsp;<a class='option deleteoption'>delete</a></div><pre class='puton-json-view'><code><%= Puton.utils.syntaxHighlight(value) %></code></pre>",tmpl.doc_collapsed="<h3 class='puton-doc-key'><%- key %><small><%- rev%></small></h3><pre class='puton-json-view'><code><%= Puton.utils.syntaxHighlight(trunc) %><code></pre>",tmpl.doc_edit="<h3 class='puton-doc-key'><%- key %><small><%- rev %></small></h3><textarea class='puton-code-edit' name='code'><%= code %></textarea><button class='puton-code-edit-cancel'>Cancel</button><button class='puton-code-edit-save'>Save</button>",tmpl.tabs="<div class='docs'></div>",tmpl.queryInput="    Map:     <textarea class='puton-code-edit puton-code-map' name='map'>function(doc) {\n\n\n\n\n}</textarea><br/>    Reduce:     <textarea class='puton-code-edit puton-code-reduce' name='reduce'>\n\n\n\n\n\n</textarea><button class='puton-run-query'>Run Query</button><div class='docs'></div>",tmpl.toolbar="<a class='button' id='query'>Run Query</a><a class='button' id='adddoc'>Add document</a><div id='puton-tab-buttons'></div>",tmpl.documents="<div class='puton-docs-container'></div><div class='puton-revs-container'></div>",tmpl.revisions="<div class='revisions'></div>",tmpl.rev_full="<h3 class='puton-doc-key'><%- key %></h3><pre class='puton-json-view'><code><%= value %></code></pre>",tmpl.tabbutton="<a class='tabbutton><%- label %></a>",tmpl.tab="<span><%- name %></span>",tmpl.closeabletab="<span><%- name %></span><div class='puton-close-tab'></div>";var compiled={};_.each(_.keys(tmpl),function(e){compiled[e]=_.template(tmpl[e])}),tmpl=compiled;var utils={};utils.syntaxHighlight=function(e){return"string"!=typeof e&&(e=JSON.stringify(e,void 0,4)),hljs.highlight("json",e,!0).value},Pouch.enableAllDbs=!0,window.Puton=function(){var Puton={};Puton=function(){return Puton._app?(Puton._app.show(),void 0):(Puton._app=new Puton.app,Puton._app.start(),void 0)},Puton.utils=utils,Puton.app=Backbone.View.extend({id:"puton",tagName:"div",initialize:function(){},start:function(){this.render(),this.mainPage()},render:function(){return this.$el.html(tmpl.app()),this},events:{changeView:"changeView",selectDB:"selectDB","click h1":"mainPage","click #puton-hide-button":"hide"},mainPage:function(){this.currentView=new v.Main({el:this.$("#puton-main")}),this.currentView.render()},show:function(){this.$el.show()},hide:function(){this.$el.hide()},selectDB:function(e,t){var n=this;Pouch(t,function(e,t){if(e)return console.error(e),void 0;var o=new m.DB(null,{db:t});o.fetch(),n.changeView(null,o)})},changeView:function(e,t){this.currentView=new v.DB({el:this.$("#puton-main"),model:t}),this.currentView.render()}});var v={};v.Main=Backbone.View.extend({initialize:function(){this.allDbs=[]},updateAllDbs:function(){var e=this;Pouch.allDbs(function(t,n){e.allDbs=n,e._render()})},events:{"keydown #puton-db-input":"submit","click .puton-dbname":"selectDb"},render:function(){return this.updateAllDbs(),this._render()},_render:function(){return this.$el.html(tmpl.mainView({allDbs:this.allDbs})),this},selectDb:function(e){var t=$(e.target).html();this.dbSelected(t)},submit:function(e){if(13===e.keyCode){var t=this.$("#puton-db-input").val();if(0===t.length)return;this.dbSelected(t)}},dbSelected:function(e){this.$el.trigger("selectDB",e)}}),v.Log=Backbone.View.extend({el:"#puton-log",initialize:function(){if(!window.PUTON_TESTS){var e=this;e.count=0,["log","info","error"].forEach(function(t){var n=console[t];console[t]=function(o){n.call(console,arguments[0]),e.log(o,t)}})}},log:function(e,t){function n(e){var t;if($.isArray(e))return t=[],e.forEach(function(e){t.push(n(e))}),t;if("object"==typeof e){t=[];for(var o in e)e.hasOwnProperty(o)&&t.push({label:o,children:n(e[o])});return t}return[{label:e}]}t=t||"log","object"==typeof e?this.$el.prepend($('<div class="log-'+t+'"/>').tree({data:n(e),autoOpen:!0,slide:!1})):this.$el.prepend(tmpl.log({count:++this.count,log:e,type:t}))}}),v.AddDocForm=Backbone.View.extend({id:"puton-add-doc",render:function(){return this.$el.html(tmpl.addDocForm()),this},events:{"click .puton-code-edit-cancel":"cancel","click .puton-code-edit-save":"save"},save:function(){this.$el.trigger("addDocSave")},cancel:function(){this.remove()}}),v.DB=Backbone.View.extend({initialize:function(){this.listenTo(this.model,"all",this.render)},events:{"click #adddoc":"addDoc","click #query":"query",deleteDocument:"deleteDocument",changeTab:"changeTab",closeTab:"closeTab",showRev:"showRev",addDocSave:"addDocSave"},showRev:function(e,t){this.revisions&&this.revisions.remove(),this.revisions=t,this.$(".puton-revs-container").html(t.render().el)},closeTab:function(e,t){if(this.toolbar.removeTab(t),t.isActive()){var n=this.toolbar.tabs[0];n.view.render(),this.toolbar.switchTo(n)}this.toolbar.render()},changeTab:function(e,t){this.toolbar.switchTo(t),this.$(".puton-docs").html(t.view.$el),t.view.rebindEvents()},deleteDocument:function(e,t){var n=this;n.model.db.get(t,function(e,o){e&&console.log(e),n.model.db.remove(o,function(){n.model.docs.remove(t)})})},addDocSave:function(e){var self=this,x=this.cm.getValue();if(x){this.addDocForm.remove();try{if(x=x.trim(),0===x.length||"{"!==x[0]||"}"!==x[x.length-1])throw"Not a valid object";try{x=JSON.parse(x)}catch(err){eval("x="+x)}if("object"!=typeof x)throw"Not a valid object";var method=self.model.db.post;x._id!==void 0&&(method=self.model.db.put),method.call(self.model.db,x,function(e,t){e&&console.error(e),self.model.db.get(t.id,function(e,t){self.model.docs.add(t,{at:0})})})}catch(err){console.error(err)}}},addDoc:function(){this.addDocForm&&this.addDocForm.remove(),this.addDocForm=new v.AddDocForm,this.$("#puton-toolbar").append(this.addDocForm.render().el),this.cm=CodeMirror.fromTextArea(this.addDocForm.$("textarea")[0],{lineNumbers:!0,tabSize:4,autofocus:!0,mode:"text/json"})},query:function(){var e=new v.Query({db:this.model.db});this.$(".puton-docs").html(e.render().el),e.initCodeMirror(),this.toolbar.addTabFor(e)},render:function(){this.$el.html(tmpl.db(this.model.toJSON())),this.toolbar=new v.Toolbar({el:this.$("#puton-toolbar")});var e=new v.Documents({collection:this.model.docs,db:this.model.db});this.$(".puton-docs").html(e.render().el),e.tabname="Main",this.toolbar.addTabFor(e)}}),v.Toolbar=Backbone.View.extend({initialize:function(){this._index=0,this.tabs=[]},addTabFor:function(e){this.tabs.forEach(function(e){e.active=!1}),this._index=this._index+1,this.tabs.push({count:this._index,active:!0,view:e}),this.render()},switchTo:function(e){this._active(e),this.render()},removeTab:function(e){this.tabs=_.filter(this.tabs,function(t){return e.view!==t.view})},_active:function(e){this.tabs.forEach(function(t){t.active=e.view===t.view?!0:!1})},render:function(){this.$el.html(tmpl.toolbar());var e=this;return this.tabs.length>1&&_.each(this.tabs,function(t){var n=new v.Tab(t);e.$("#puton-tab-buttons").append(n.render().el)}),this}}),v.Tab=Backbone.View.extend({className:"puton-tab-button",initialize:function(e){this._isActive=e.active,this.count=e.count,this.view=e.view},events:{"click .puton-close-tab":"closeTab",click:"changeTab"},closeTab:function(e){e.preventDefault(),e.stopPropagation(),this.$el.trigger("closeTab",this)},changeTab:function(){this.$el.trigger("changeTab",this)},isActive:function(){return this._isActive},render:function(){return this.view.tabname?this.$el.html(tmpl.tab({name:this.view.tabname})):(this.$el.html(tmpl.closeabletab({name:"Query "+this.count})),this.$el.addClass("closeable")),this.isActive()?this.$el.addClass("active"):this.$el.removeClass("active"),this}}),v.Query=Backbone.View.extend({initialize:function(e){this.state=0,this.db=e.db,this.docs=new m.Documents(null,{db:this.db})},events:{"click .puton-run-query":"runQuery"},rebindEvents:function(){this.delegateEvents(),this.documentsView.rebindEvents()},render:function(){return 0===this.state&&this.$el.html(tmpl.queryInput()),this.documentsView=new v.Documents({collection:this.docs}),this.$(".docs").html(this.documentsView.render().el),this},initCodeMirror:function(){var e=this;e.cm={},["map","reduce"].forEach(function(t){e.cm[t]=CodeMirror.fromTextArea(e.$(".puton-code-"+t).get(0),{lineNumbers:!0,tabSize:4,indentUnit:4,indentWithTabs:!0,mode:"text/javascript"})}),e.cm.map.focus()},runQuery:function(){var self=this,map=self.cm.map.getValue().trim(),reduce=self.cm.reduce.getValue().trim(),hasReduce,query={};eval("query.map = "+map),reduce?(eval("query.reduce = "+reduce),hasReduce=!0):hasReduce=!1,this.db.query(query,{reduce:hasReduce,include_docs:!0,conflicts:!0},function(e,t){self.docs.reset(),t.rows.forEach(function(e){self.docs.add({key:e.key,value:e.value})})})}}),v.Documents=Backbone.View.extend({initialize:function(e){this.listenTo(this.collection,"reset",this.render),this.listenTo(this.collection,"add",this.render),this.listenTo(this.collection,"remove",this.render),this.db=e.db,this.docViews=[]},rebindEvents:function(){this.docViews.forEach(function(e){e.delegateEvents()})},render:function(){this.$el.html(tmpl.documents());var e=document.createDocumentFragment(),t=this.db,n=this;return this.collection.each(function(o){var r=new v.Document({model:o,db:t});n.docViews.push(r),e.appendChild(r.render().el)}),this.$(".puton-docs-container").html(e),this}}),v.Revisions=Backbone.View.extend({initialize:function(e){this.db=e.db,this.doc_id=e.doc_id,this.type=e.type},render:function(){return"list"===this.type?this.renderList.apply(this,arguments):"tree"===this.type&&this.renderTree.apply(this,arguments),this},renderTree:function(){var e=this.$el,t=this.doc_id;this.db.visualizeRevTree(t,function(t,n){return t?console.error(t):(e.html(n),void 0)})},renderList:function(){var e=this,t=this.$el,n=this.doc_id;this.db.get(n,{revs:!0,revs_info:!0},function(o,r){function i(){t.html(a)}if(o)return console.error(o);var a=$(tmpl.revisions({}));r._revs_info.forEach(function(t){var o=new v.Revision({db:this.db}),r=$("<div/>");a.append(r),"available"===t.status?e.db.get(n,{rev:t.rev},function(e,t){return e?console.error(e):(r.html(o.render(t,n).el),i(),void 0)}):r.html(o.render(!1,n).el)}),i()})}}),v.Revision=Backbone.View.extend({className:"puton-revision",render:function(e,t){var n=e;return n?this.$el.html(tmpl.rev_full({key:n._rev,value:Puton.utils.syntaxHighlight(n)})):this.$el.html(tmpl.rev_full({key:t,value:"compacted"})),this}}),v.Document=Backbone.View.extend({className:"puton-doc",initialize:function(e){this.show="collapsed",this.db=e.db},render:function(){var e=this.model,t=this.model.key(),n=this.model.rev();if("collapsed"===this.show)this.$el.html(tmpl.doc_collapsed({key:t,trunc:JSON.stringify(e.toJSON()).substring(0,50)+"...",rev:n})),this.revisions&&this.revisions.remove();else if("full"===this.show)this.$el.html(tmpl.doc_full({key:t,value:e.toJSON(),rev:n})),this.model.id||this.$el.find(".optionsbar").hide();else if("edit"===this.show){var o=e.toJSON();["_rev","_id"].forEach(function(e){e in o&&delete o[e]}),this.$el.html(tmpl.doc_edit({key:t,code:JSON.stringify(o,void 0,4),rev:n})),this.codeEdit=CodeMirror.fromTextArea(this.$el.find(".puton-code-edit").get(0),{lineNumbers:!1,tabSize:4,indentUnit:4,indentWithTabs:!0,mode:"application/json",autofocus:!0})}return this},saveEdit:function(e){function parseJSON(json){var tr=!1;try{tr=JSON.parse(json)}catch(err){try{tr=$.parseJSON(json)}catch(err2){tr=eval("("+json+")")}}return tr}var self=this;e.preventDefault(),e.stopPropagation();var json=this.codeEdit.getValue().trim();try{if(!json||"{"!==json[0]||"}"!==json[json.length-1]||(json=parseJSON(json))===!1)throw"Not a valid object";json._id=self.model.toJSON()._id,json._rev=self.model.toJSON()._rev,self.db.put(json,function(e){return e?console.error(e):(self.db.get(json._id,function(e,t){return e?console.error(e):(self.model.set(t),self.show="full",self.render(),void 0)}),void 0)})}catch(err){console.error(err),this.show="full",this.render()}},cancelEdit:function(e){e.preventDefault(),e.stopPropagation(),this.show="full",this.render()},events:{"click .revoption":"revOption","click .revtreeoption":"revTreeOption","click .editoption":"editOption","click .deleteoption":"deleteOption",click:"toggleView","click .puton-code-edit-save":"saveEdit","click .puton-code-edit-cancel":"cancelEdit"},editOption:function(e){e.preventDefault(),e.stopPropagation(),this.show="edit",this.render()},deleteOption:function(e){e.preventDefault(),e.stopPropagation(),confirm("Delete Document?")&&this.$el.trigger("deleteDocument",this.model.id)},revOption:function(e){e.preventDefault(),e.stopPropagation(),this.showRev("list")},revTreeOption:function(e){e.preventDefault(),e.stopPropagation(),this.showRev("tree")},showRev:function(e){this.revisions=new v.Revisions({db:this.db,doc_id:this.model.toJSON()._id,type:e}),this.$el.trigger("showRev",this.revisions)},toggleView:function(e){e.preventDefault(),e.stopPropagation(),"edit"!==this.show&&(this.show="collapsed"===this.show?"full":"collapsed",this.render())}}),Puton.views=v;var m={};return Backbone.Model.prototype.idAttribute="_id",m.Document=Backbone.Model.extend({key:function(){return this.get("key")||this.id},rev:function(){return this.attributes._rev}}),m.Documents=Backbone.Collection.extend({model:m.Document,initialize:function(e,t){this.db=t.db},fetch:function(){var e=this;this.db.allDocs({include_docs:!0},function(t,n){e.add(_.pluck(n.rows,"doc"))})}}),m.DB=Backbone.Model.extend({initialize:function(e,t){this.db=t.db,this.docs=new m.Documents(null,{db:this.db}),this.docs.fetch()},fetch:function(){var e=this;this.db.info(function(t,n){e.set(n)})},defaults:{db_name:"",doc_count:"",update_seq:""}}),m.Tab=Backbone.Model.extend({}),m.Tabs=Backbone.Collection.extend({initialize:function(){},model:m.Tab}),Puton.models=m,Puton}(),$(function(){Puton(),$("body").append(window.Puton._app.$el),-1===window.PUTON_LOADED&&(window.PUTON_LOADED=1)});