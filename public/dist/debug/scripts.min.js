var tmpl={};tmpl.app="<h1 id='puton-heading'>Puton</h1><div id='puton-main'></div><a id='puton-hide-button'>Close</a><div id='puton-log'></div>",tmpl.mainView="<div class='puton-section'>    <h2>Open a Pouch:</h2>    <div class='puton-main-input'>        <label class='puton-db-label' for='puton-db-input'>Pouch(</label>        <input type='text' id='puton-db-input'/>        <label class='puton-db-label' for='puton-db-input'>);</label>    </div></div><div class='puton-section'>    <h2>Existing Pouches:</h2>    <%  if (allDbs.length === 0) { %>        <p class='puton-db-info'>No Existing Pouches :(</p>    <%  } else { %>        <ul class='puton-dbnames'>            <%  _.each(allDbs, function(db) { %>                <li class='puton-dbname'><%= db %></li>            <% }) %>        </ul>    <% } %></div>",tmpl.log="<p class='log log-<%- type %>'>    <b>        <small class='count'>            <%- count %>        </small>    </b>    <%- log %></p>",tmpl.db="<h2 id='puton-dbname'><%- db_name %></h2><p class='puton-dbinfo'>    &middot;    <b>doc_count: </b>    <%- doc_count %>    &middot;    <b>update_seq: </b>    <%- update_seq %></p><div id='puton-toolbar'></div><div id='tabs'>    <div class='docs'></div></div>",tmpl.doc_full="<h3 class='puton-doc-key'><%- key %></h3><div class='puton-doc-optionsbar'><a class='option revtreeoption'>rev-tree</a>&nbsp;<a class='option revoption'>rev-list</a>&nbsp;<a class='option editoption'>edit</a>&nbsp;<a class='option deleteoption'>delete</a></div><pre class='puton-json-view'><%= value %></pre>",tmpl.doc_collapsed="<h3 class='puton-doc-key'><%- key %></h3><span class='puton-json-view'><%- trunc %></span>",tmpl.doc_edit="<h3 class='puton-doc-key'><%- key %></h3><textarea class='code-edit' name='code'><%= code %></textarea><button class='code-edit-save'>Save</button>",tmpl.tabs="<div class='docs'></div>",tmpl.queryInput="    Map:     <textarea class='code-edit code-map' name='map'>function(doc) {\n\n\n}</textarea>    Reduce:     <textarea class='code-edit code-reduce' name='reduce'></textarea>    <button class='run'>Run Query</button>    <div class='docs'></div>",tmpl.toolbar="<a class='button' id='query'>Run Query</a><a class='button' id='adddoc'>Add document</a><div id='puton-tabbuttons'></div>",tmpl.documents="<div class='docs-container'></div><div id='puton-revs-container'></div>",tmpl.revisions="<div class='revisions'></div>",tmpl.rev_full="<h3 class='key'><%- key %></h3><pre class='value'><%= value %></pre>",tmpl.tabbutton="<a class='tabbutton><%- label %></a>";var compiled={};_.each(_.keys(tmpl),function(e){compiled[e]=_.template(tmpl[e])}),tmpl=compiled;var utils={};utils.syntaxHighlight=function(e){return"string"!=typeof e&&(e=JSON.stringify(e,void 0,2)),e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),e.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,function(e){var t="number";return/^"/.test(e)?t=/:$/.test(e)?"key":"string":/true|false/.test(e)?t="boolean":/null/.test(e)&&(t="null"),'<span class="'+t+'">'+e+"</span>"})},Pouch.enableAllDbs=!0,window.Puton=function(){var Puton={};Puton=function(){return Puton._app?(Puton._app.show(),void 0):(Puton._app=new Puton.app,Puton._app.start(),void 0)},Puton.utils=utils,Puton.app=Backbone.View.extend({id:"puton",tagName:"div",initialize:function(){},start:function(){this.render(),this.logview=new v.Log({el:this.$("#puton-log")}),this.mainPage()},render:function(){return this.$el.html(tmpl.app()),this},events:{changeView:"changeView",selectDB:"selectDB","click h1":"mainPage","click #puton-hide-button":"hide"},mainPage:function(){this.currentView=new v.Main({el:this.$("#puton-main")}).render()},show:function(){this.$el.show()},hide:function(){this.$el.hide()},selectDB:function(e,t){var n=this;Pouch(t,function(e,t){if(e)return console.error(e),void 0;var o=new m.DB(null,{db:t});n.changeView(null,o)})},changeView:function(e,t){this.currentView=new v.DB({el:this.$("#puton-main"),model:t}),this.currentView.render()}});var v={};v.Main=Backbone.View.extend({initialize:function(){this.allDbs=[]},updateAllDbs:function(){var e=this;Pouch.allDbs(function(t,n){e.allDbs=n,e._render()})},events:{"keydown #puton-db-input":"submit","click .puton-dbname":"selectDb"},render:function(){return this.updateAllDbs(),this._render()},_render:function(){return this.$el.html(tmpl.mainView({allDbs:this.allDbs})),this},selectDb:function(e){var t=$(e.target).html();this.dbSelected(t)},submit:function(e){if(13===e.keyCode){var t=this.$("#puton-db-input").val();if(0===t.length)return;this.dbSelected(t)}},dbSelected:function(e){this.$el.trigger("selectDB",e)}}),v.Log=Backbone.View.extend({el:"#puton-log",initialize:function(){if(!window.PUTON_TESTS){var e=this;e.count=0,["log","info","error"].forEach(function(t){var n=console[t];console[t]=function(o){n.call(console,arguments[0]),e.log(o,t)}})}},log:function(e,t){function n(e){var t;if($.isArray(e))return t=[],e.forEach(function(e){t.push(n(e))}),t;if("object"==typeof e){t=[];for(var o in e)e.hasOwnProperty(o)&&t.push({label:o,children:n(e[o])});return t}return[{label:e}]}t=t||"log","object"==typeof e?this.$el.prepend($('<div class="log-'+t+'"/>').tree({data:n(e),autoOpen:!0,slide:!1})):this.$el.prepend(tmpl.log({count:++this.count,log:e,type:t}))}}),v.DB=Backbone.View.extend({initialize:function(){this.listenTo(this.model,"all",this.render)},events:{"click #adddoc":"addDoc","click #query":"query",deleteDocument:"deleteDocument",changeTab:"changeTab"},changeTab:function(e,t){t.render(),this.toolbar.active(t)},deleteDocument:function(e,t){var n=this;n.model.db.get(t,function(e,o){e&&console.log(e),n.model.db.remove(o,function(){n.model.docs.remove(t)})})},addDoc:function(e){var self=this,x=prompt("Document: ","{}").trim();try{if(0===x.length||"{"!==x[0]||"}"!==x[x.length-1])throw"Not a valid object";try{x=JSON.parse(x)}catch(err){eval("x="+x)}if("object"!=typeof x)throw"Not a valid object";self.model.db.put(x,function(e,t){e&&console.error(e),self.model.db.get(t.id,function(e,t){self.model.docs.add(t,{at:0})})})}catch(err){console.error(err)}},query:function(){var e=new v.Query({el:this.$(".docs"),db:this.model.db});this.toolbar.addtab(e),e.render()},render:function(){this.$el.html(tmpl.db(this.model.toJSON())),this.toolbar=new v.Toolbar({el:this.$("#puton-toolbar")});var e=new v.Documents({el:this.$(".docs"),collection:this.model.docs});e.render(),e.tabname="Main",this.toolbar.addtab(e)}}),v.Toolbar=Backbone.View.extend({initialize:function(){this.tabs=[],this.tabviews=[]},addtab:function(e){this.tabs.push(e),this.render(),this.active(e)},active:function(e){_.each(this.tabviews,function(t){t.view===e?t.$el.addClass("active"):t.$el.removeClass("active")})},render:function(){this.$el.html(tmpl.toolbar());var e=this;return this.tabs.length>1&&_.each(this.tabs,function(t,n){var o=new v.Tab({count:n,view:t});e.tabviews.push(o),e.$("#puton-tabbuttons").append(o.render().el)}),this}}),v.Tab=Backbone.View.extend({className:"tabbutton",initialize:function(e){this.count=e.count,this.view=e.view},events:{click:"changeTab"},changeTab:function(){this.$el.trigger("changeTab",this.view)},render:function(){return this.$el.html(this.view.tabname||"Query "+this.count),this}}),v.Query=Backbone.View.extend({initialize:function(e){this.state=0,this.db=e.db,this.docs=new m.Documents(null,{db:this.db,populate:!1})},events:{"click .run":"runQuery"},render:function(){var e=this;0===this.state&&this.$el.html(tmpl.queryInput()),e.cm={},["map","reduce"].forEach(function(t){e.cm[t]=CodeMirror.fromTextArea(e.$el.find(".code-"+t).get(0),{lineNumbers:!0,tabSize:4,indentUnit:4,indentWithTabs:!0,mode:"text/javascript"})}),e.cm.map.focus(),this.documentsView=new v.Documents({el:this.$el.find(".docs"),collection:this.docs}),this.documentsView.render()},runQuery:function(){var self=this,map=self.cm.map.getValue().trim(),reduce=self.cm.reduce.getValue().trim(),hasReduce,query={};eval("query.map = "+map),reduce?(eval("query.reduce = "+reduce),hasReduce=!0):hasReduce=!1,this.db.query(query,{reduce:hasReduce,include_docs:!0,conflicts:!0},function(e,t){self.docs.reset(),t.rows.forEach(function(e){self.docs.add({key:e.key,value:e.value})})})}}),v.Documents=Backbone.View.extend({initialize:function(){this.listenTo(this.collection,"reset",this.render),this.listenTo(this.collection,"add",this.render),this.listenTo(this.collection,"remove",this.render)},render:function(){var e=document.createDocumentFragment();this.collection.each(function(t){var n=new v.Document({model:t,db:this.db});e.appendChild(n.render().el)}),this.$el.html(tmpl.documents),this.$el.find(".docs-container").html(e)}}),v.Revisions=Backbone.View.extend({className:"revs",initialize:function(e){this.db=e.db,this.doc_id=e.doc_id,this.type=e.type},render:function(){"list"===this.type?this.renderList.apply(this,arguments):"tree"===this.type&&this.renderTree.apply(this,arguments)},renderTree:function(){var e=this.$el,t=this.doc_id;this.db.visualizeRevTree(t,function(t,n){return t?console.error(t):(e.html(n),void 0)})},renderList:function(){var e=this.$el,t=this.doc_id;this.db.get(t,{revs:!0,revs_info:!0},function(n,o){function r(){e.html(i)}if(n)return console.error(n);var i=$(tmpl.revisions({}));o._revs_info.forEach(function(e){var n=new v.Revision({db:this.db}),o=$("<div/>");i.append(o),"available"===e.status?this.db.get(t,{rev:e.rev},function(e,i){return e?console.error(e):(o.html(n.render(i,t).el),r(),void 0)}):o.html(n.render(!1,t).el)}),r()})}}),v.Revision=Backbone.View.extend({className:"rev",render:function(e,t){var n=e;return n?this.$el.html(tmpl.rev_full({key:n._rev,value:Puton.utils.syntaxHighlight(n)})):this.$el.html(tmpl.rev_full({key:t,value:"compacted"})),this}}),v.Document=Backbone.View.extend({className:"puton-doc",initialize:function(e){this.show="collapsed",this.db=e.db},render:function(){var e=this.model;if("collapsed"===this.show)this.$el.html(tmpl.doc_collapsed({key:e.toJSON().key||this.model.id,trunc:JSON.stringify(e.toJSON()).substring(0,50)+"..."}));else if("full"===this.show)this.$el.html(tmpl.doc_full({key:e.toJSON().key||this.model.id,value:Puton.utils.syntaxHighlight(e.toJSON())})),this.model.id||this.$el.find(".optionsbar").hide();else if("edit"===this.show){var t=e.toJSON();["_rev","_id"].forEach(function(e){e in t&&delete t[e]}),this.$el.html(tmpl.doc_edit({key:e.toJSON().key||this.model.id,code:JSON.stringify(t,void 0,2)})),this.codeEdit=CodeMirror.fromTextArea(this.$el.find(".code-edit").get(0),{lineNumbers:!1,tabSize:4,indentUnit:4,indentWithTabs:!0,mode:"application/json",autofocus:!0})}return this},saveEdit:function(e){var t=this;e.preventDefault(),e.stopPropagation();var n=this.codeEdit.getValue().trim();try{if(!n||"{"!==n[0]||"}"!==n[n.length-1]||(n=JSON.parse(n))===!1)throw"Not a valid object";n._id=this.model.toJSON()._id,n._rev=this.model.toJSON()._rev,this.db.put(n,function(e){return e?console.error(e):(this.db.get(n._id,function(e,n){return e?console.error(e):(t.model.set(n),t.show="full",t.render(),void 0)}),void 0)})}catch(o){console.error(o),this.show="full",this.render()}},events:{"click .revoption":"revOption","click .revtreeoption":"revTreeOption","click .editoption":"editOption","click .deleteoption":"deleteOption",click:"toggleView","click .code-edit-save":"saveEdit"},editOption:function(e){e.preventDefault(),e.stopPropagation(),this.show="edit",this.render()},deleteOption:function(e){e.preventDefault(),e.stopPropagation(),confirm("Delete Document?")&&this.$el.trigger("deleteDocument",this.model.id)},revOption:function(e){e.preventDefault(),e.stopPropagation();var t=new v.Revisions({el:$("#puton-revs-container"),db:this.db,doc_id:this.model.toJSON()._id,type:"list"});t.render()},revTreeOption:function(e){e.preventDefault(),e.stopPropagation();var t=new v.Revisions({el:$("#puton-revs-container"),db:this.db,doc_id:this.model.toJSON()._id,type:"tree"});t.render()},toggleView:function(e){e.preventDefault(),e.stopPropagation(),"edit"!==this.show&&(this.show="collapsed"===this.show?"full":"collapsed",this.render())}}),Puton.views=v;var m={};return Backbone.Model.prototype.idAttribute="_id",m.Document=Backbone.Model.extend({}),m.Documents=Backbone.Collection.extend({initialize:function(e,t){var n=this;this.db=t.db,"populate"in t&&t.populate===!1||this.db.allDocs({include_docs:!0},function(e,t){n.add(_.pluck(t.rows,"doc"))})},model:m.Document}),m.DB=Backbone.Model.extend({initialize:function(e,t){var n=this;this.db=t.db,this.docs=new m.Documents(null,{db:this.db}),this.db.info(function(e,t){n.set(t)})},defaults:{db_name:"",doc_count:"",update_seq:""}}),m.Tab=Backbone.Model.extend({}),m.Tabs=Backbone.Collection.extend({initialize:function(){},model:m.Tab}),Puton.models=m,Puton}(),$(function(){Puton(),$("body").append(window.Puton._app.$el),-1===window.PUTON_LOADED&&(window.PUTON_LOADED=1)});