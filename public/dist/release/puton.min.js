function syntaxHighlight(e){return"string"!=typeof e&&(e=JSON.stringify(e,void 0,2)),e=e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),e.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g,function(e){var t="number";return/^"/.test(e)?t=/:$/.test(e)?"key":"string":/true|false/.test(e)?t="boolean":/null/.test(e)&&(t="null"),'<span class="'+t+'">'+e+"</span>"})}var tmpl={};tmpl.app="<h1>Puton</h1><div id='puton-main'></div><a href='#' id='hide-button'>Close</a><div id='log'></div>",tmpl.mainView="<b><label for='db'>db name: </label></b><input type='text' id='db'/>",tmpl.log="<p class='log log-<%- type %>'>    <b>        <small class='count'>            <%- count %>        </small>    </b>    <%- log %></p>",tmpl.doc_full="<div class='optionsbar'>    <a class='option revoption'>revs</a>    &nbsp;|&nbsp;    <a class='option editoption'>edit</a>    &nbsp;|&nbsp;    <a class='option deleteoption'>delete</a></div><h3 class='key'><%- key %></h3><pre class='value'><%= value %></pre>",tmpl.doc_collapsed="<span class='key'><%- key %></span>&nbsp;<span class='value'><%- trunc %></span>",tmpl.doc_edit="<textarea class='code-edit' name='code'><%= code %></textarea><button class='code-edit-save'>Save</button>",tmpl.tabs="<div class='docs'></div>",tmpl.queryInput="    Map:     <textarea class='code-edit code-map' name='map'>function(doc) {\n\n\n}</textarea>    Reduce:     <textarea class='code-edit code-reduce' name='reduce'></textarea>    <button class='run'>Run Query</button>    <div class='docs'></div>    ",tmpl.db="    <h2><%- db_name %></h2>    <small>(database name)</small>    <p>        <b>doc_count: </b>        <%- doc_count %>    </p>    <p>        <b>update_seq: </b>        <%- update_seq %>    </p>    <div id='puton-toolbar'>    </div>    <div id='tabs'>    <div class='docs'></div>    </div>",tmpl.toolbar="    <a class='button' id='query'>Run Query</a>    <a class='button' id='adddoc'>Add document</a>    <div id='puton-tabbuttons'></div>",tmpl.documents="    <div class='docs-container'></div>    <div id='puton-revs-container'></div>",tmpl.revisions="<div class='revisions'></div>",tmpl.rev_full="    <h3 class='key'><%- key %></h3>    <pre class='value'><%= value %></pre>",tmpl.tabbutton="<a class='tabbutton><%- label %></a>";var compiled={};_.each(_.keys(tmpl),function(e){compiled[e]=_.template(tmpl[e])}),tmpl=compiled,window.Puton=function(){var Puton=function(){this._app=new Puton.app,this._app.start()};Puton.app=Backbone.View.extend({id:"puton-container",tagName:"div",initialize:function(){},start:function(){this.render(),this.logview=new v.Log,this.mainPage()},render:function(){return this.$el.html(tmpl.app()),this},events:{changeView:"changeView",selectDB:"selectDB","click h1":"mainPage","click #hide-button":"hide"},mainPage:function(){this.currentView=new v.Main({el:this.$("#puton-main")}).render()},hide:function(){this.$el.hide()},selectDB:function(e,t){var i=this;Pouch(t,function(e,t){if(e)return console.error(e),void 0;window.db=t;var n=new m.DB(null,{db:t});i.changeView(null,n)})},changeView:function(e,t){this.currentView=new v.DB({el:this.$("#puton-main"),model:t}),this.currentView.render()}});var v={};v.Main=Backbone.View.extend({events:{"keydown #db":"submit"},render:function(){return this.$el.html(tmpl.mainView()),this},submit:function(e){if(13===e.keyCode){var t=this.$("#db").val();if(0===t.length)return;this.$el.trigger("selectDB",t)}}}),v.Log=Backbone.View.extend({el:"#log",initialize:function(){var e=this;e.count=0,["log","info","error"].forEach(function(t){var i=console[t];console[t]=function(n){i.call(console,arguments[0]),e.log(n,t)}})},log:function(e,t){function i(e){var t;if($.isArray(e))return t=[],e.forEach(function(e){t.push(i(e))}),t;if("object"==typeof e){t=[];for(var n in e)e.hasOwnProperty(n)&&t.push({label:n,children:i(e[n])});return t}return[{label:e}]}t=t||"log","object"==typeof e?this.$el.prepend($('<div class="log-'+t+'"/>').tree({data:i(e),autoOpen:!0,slide:!1})):this.$el.prepend(tmpl.log({count:++this.count,log:e,type:t}))}}),v.DB=Backbone.View.extend({initialize:function(){this.listenTo(this.model,"all",this.render)},events:{"click #adddoc":"addDoc","click #query":"query",deleteDocument:"deleteDocument",changeTab:"changeTab"},changeTab:function(e,t){t.render(),this.toolbar.active(t)},deleteDocument:function(e,t){var i=this;i.model.db.get(t,function(e,n){e&&console.log(e),i.model.db.remove(n,function(){i.model.docs.remove(t)})})},addDoc:function(e){var self=this,x=prompt("Document: ","{}").trim();try{if(0===x.length||"{"!==x[0]||"}"!==x[x.length-1])throw"Not a valid object";try{x=JSON.parse(x)}catch(err){eval("x="+x)}if("object"!=typeof x)throw"Not a valid object";self.model.db.put(x,function(e,t){e&&console.error(e),self.model.db.get(t.id,function(e,t){self.model.docs.add(t,{at:0})})})}catch(err){console.error(err)}},query:function(){var e=new v.Query({el:this.$(".docs"),db:this.model.db});this.toolbar.addtab(e),e.render()},render:function(){this.$el.html(tmpl.db(this.model.toJSON())),this.toolbar=new v.Toolbar({el:this.$("#puton-toolbar")});var e=new v.Documents({el:this.$(".docs"),collection:this.model.docs});e.render(),e.tabname="Main",this.toolbar.addtab(e)}}),v.Toolbar=Backbone.View.extend({initialize:function(){this.tabs=[],this.tabviews=[]},addtab:function(e){this.tabs.push(e),this.render(),this.active(e)},active:function(e){_.each(this.tabviews,function(t){t.view===e?t.$el.addClass("active"):t.$el.removeClass("active")})},render:function(){this.$el.html(tmpl.toolbar());var e=this;return this.tabs.length>1&&_.each(this.tabs,function(t,i){var n=new v.Tab({count:i,view:t});e.tabviews.push(n),e.$("#puton-tabbuttons").append(n.render().el)}),this}}),v.Tab=Backbone.View.extend({className:"tabbutton",initialize:function(e){this.count=e.count,this.view=e.view},events:{click:"changeTab"},changeTab:function(){this.$el.trigger("changeTab",this.view)},render:function(){return this.$el.html(this.view.tabname||"Query "+this.count),this}}),v.Query=Backbone.View.extend({initialize:function(e){this.state=0,this.db=e.db,this.docs=new m.Documents(null,{db:this.db,populate:!1})},events:{"click .run":"runQuery"},render:function(){var e=this;0===this.state&&this.$el.html(tmpl.queryInput()),e.cm={},["map","reduce"].forEach(function(t){e.cm[t]=CodeMirror.fromTextArea(e.$el.find(".code-"+t).get(0),{lineNumbers:!0,tabSize:4,indentUnit:4,indentWithTabs:!0,mode:"text/javascript"})}),e.cm.map.focus(),this.documentsView=new v.Documents({el:this.$el.find(".docs"),collection:this.docs}),this.documentsView.render()},runQuery:function(){var self=this,map=self.cm.map.getValue().trim(),reduce=self.cm.reduce.getValue().trim(),hasReduce,query={};eval("query.map = "+map),reduce?(eval("query.reduce = "+reduce),hasReduce=!0):hasReduce=!1,this.db.query(query,{reduce:hasReduce,include_docs:!0,conflicts:!0},function(e,t){self.docs.reset(),t.rows.forEach(function(e){self.docs.add({key:e.key,value:e.value})})})}}),v.Documents=Backbone.View.extend({initialize:function(){this.listenTo(this.collection,"reset",this.render),this.listenTo(this.collection,"add",this.render),this.listenTo(this.collection,"remove",this.render)},render:function(){var e=document.createDocumentFragment();this.collection.each(function(t){var i=new v.Document({model:t,db:this.db});e.appendChild(i.render().el)}),this.$el.html(tmpl.documents),this.$el.find(".docs-container").html(e)}}),v.Revisions=Backbone.View.extend({className:"revs",initialize:function(e){this.db=e.db,this.doc_id=e.doc_id},render:function(){var e=this.$el,t=this.doc_id;this.db.get(t,{revs:!0,revs_info:!0},function(i,n){function o(){e.html(s)}if(i)return console.error(i);var s=$(tmpl.revisions({}));n._revs_info.forEach(function(e){var i=new v.Revision({db:this.db}),n=$("<div/>");s.append(n),"available"===e.status?this.db.get(t,{rev:e.rev},function(e,s){return e?console.error(e):(n.html(i.render(s,t).el),o(),void 0)}):n.html(i.render(!1,t).el)}),o()})}}),v.Revision=Backbone.View.extend({className:"rev",render:function(e,t){var i=e;return i?this.$el.html(tmpl.rev_full({key:i._rev,value:syntaxHighlight(i)})):this.$el.html(tmpl.rev_full({key:t,value:"compacted"})),this}}),v.Document=Backbone.View.extend({className:"doc",initialize:function(e){this.show="collapsed",this.db=e.db},render:function(){var e=this.model;if("collapsed"===this.show)this.$el.html(tmpl.doc_collapsed({key:e.toJSON().key||this.model.id,trunc:JSON.stringify(e.toJSON()).substring(0,20)+"..."}));else if("full"===this.show)this.$el.html(tmpl.doc_full({key:e.toJSON().key||this.model.id,value:syntaxHighlight(e.toJSON())})),this.model.id||this.$el.find(".optionsbar").hide();else if("edit"===this.show){var t=e.toJSON();["_rev","_id"].forEach(function(e){e in t&&delete t[e]}),this.$el.html(tmpl.doc_edit({code:JSON.stringify(t,void 0,2)})),this.codeEdit=CodeMirror.fromTextArea(this.$el.find(".code-edit").get(0),{lineNumbers:!1,tabSize:4,indentUnit:4,indentWithTabs:!0,mode:"application/json",autofocus:!0})}return this},saveEdit:function(e){var t=this;e.preventDefault(),e.stopPropagation();var i=this.codeEdit.getValue().trim();try{if(!i||"{"!==i[0]||"}"!==i[i.length-1]||(i=JSON.parse(i))===!1)throw"Not a valid object";i._id=this.model.toJSON()._id,i._rev=this.model.toJSON()._rev,this.db.put(i,function(e){return e?console.error(e):(this.db.get(i._id,function(e,i){return e?console.error(e):(t.model.set(i),t.show="full",t.render(),void 0)}),void 0)})}catch(n){console.error(n),this.show="full",this.render()}},events:{"click .revoption":"revOption","click .editoption":"editOption","click .deleteoption":"deleteOption",click:"toggleView","click .code-edit-save":"saveEdit"},editOption:function(e){e.preventDefault(),e.stopPropagation(),this.show="edit",this.render()},deleteOption:function(e){e.preventDefault(),e.stopPropagation(),confirm("Delete Document?")&&this.$el.trigger("deleteDocument",this.model.id)},revOption:function(e){e.preventDefault(),e.stopPropagation();var t=new v.Revisions({el:$("#puton-revs-container"),db:this.db,doc_id:this.model.toJSON()._id});t.render()},toggleView:function(e){e.preventDefault(),e.stopPropagation(),"edit"!==this.show&&(this.show="collapsed"===this.show?"full":"collapsed",this.render())}}),Puton.views=v;var m={};return Backbone.Model.prototype.idAttribute="_id",m.Document=Backbone.Model.extend({}),m.Documents=Backbone.Collection.extend({initialize:function(e,t){var i=this;this.db=t.db,"populate"in t&&t.populate===!1||this.db.allDocs({include_docs:!0},function(e,t){i.add(_.pluck(t.rows,"doc"))})},model:m.Document}),m.DB=Backbone.Model.extend({initialize:function(e,t){var i=this;this.db=t.db,this.docs=new m.Documents(null,{db:this.db}),this.db.info(function(e,t){i.set(t)})},defaults:{db_name:"",doc_count:"",update_seq:""}}),m.Tab=Backbone.Model.extend({}),m.Tabs=Backbone.Collection.extend({initialize:function(){},model:m.Tab}),Puton.models=m,Puton}(),$(function(){var e=new Puton;$("body").append(e._app.$el),-1===window.PUTON_LOADED&&(window.PUTON_LOADED=1)});